<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magic English Garden - Cloud Sync Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Quicksand:wght@500;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global state for game
        window.gameCore = {
            db: null,
            user: null,
            appId: typeof __app_id !== 'undefined' ? __app_id : 'default-garden-id'
        };

        // Initialize Firebase if config exists
        if (typeof __firebase_config !== 'undefined') {
            const firebaseConfig = JSON.parse(__firebase_config);
            const app = initializeApp(firebaseConfig);
            window.gameCore.auth = getAuth(app);
            window.gameCore.db = getFirestore(app);

            const initAuth = async () => {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(window.gameCore.auth, __initial_auth_token);
                } else {
                    await signInAnonymously(window.gameCore.auth);
                }
            };

            initAuth().catch(console.error);
            onAuthStateChanged(window.gameCore.auth, (user) => {
                window.gameCore.user = user;
                if (user) {
                    // Start loading progress once authenticated
                    loadProgressFromCloud();
                }
            });
        }
    </script>

    <style>
        body {
            font-family: 'Quicksand', 'Microsoft JhengHei', sans-serif;
            background: #e0f2fe;
            height: 100vh;
            margin: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            user-select: none;
        }

        @media (min-width: 1024px) {
            body { flex-direction: row; }
            .left-section { flex: 1.2; height: 100vh; position: relative; border-right: 8px solid #4ade80; }
            .right-section { flex: 0.8; height: 100vh; display: flex; flex-direction: column; overflow-y: auto; background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(10px); }
        }

        .title-font { font-family: 'Fredoka One', cursive; }
        .grass { position: absolute; bottom: 0; width: 100%; height: 18vh; background: #4ade80; border-top: 8px solid #22c55e; z-index: 1; }
        
        .plant-container {
            position: relative;
            z-index: 10;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
            height: 60%;
            margin-bottom: 20px;
        }

        .plant-sprite {
            transition: all 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transform-origin: bottom center;
            filter: drop-shadow(0 10px 10px rgba(0,0,0,0.1));
            font-size: 100px;
        }

        .fruit-on-tree {
            position: absolute;
            top: 15%;
            display: flex;
            justify-content: center;
            gap: 15px;
            pointer-events: none;
            z-index: 15;
            animation: popIn 0.8s forwards;
        }

        @keyframes popIn { 0% { transform: scale(0); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

        .bounce { animation: bounce 2s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0) scale(var(--current-scale)); } 50% { transform: translateY(-12px) scale(calc(var(--current-scale) * 1.03)); } }

        .shake { animation: shake 0.5s ease-in-out; }
        @keyframes shake { 0%, 100% { transform: translateX(0) scale(var(--current-scale)); } 25% { transform: translateX(-15px) rotate(-10deg) scale(var(--current-scale)); } 75% { transform: translateX(15px) rotate(10deg) scale(var(--current-scale)); } }

        .danger-shake { animation: danger-shake 0.3s infinite; }
        @keyframes danger-shake { 0%, 100% { transform: translate(0,0); } 20% { transform: translate(-3px, 0); } 40% { transform: translate(3px, 0); } 60% { transform: translate(-3px, 0); } 80% { transform: translate(3px, 0); } }

        .celebration-overlay { position: fixed; inset: 0; background: rgba(255, 255, 255, 0.95); z-index: 200; display: none; flex-direction: column; align-items: center; justify-content: center; animation: fadeIn 0.5s forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        #wateringCan { position: absolute; font-size: 110px; opacity: 0; pointer-events: none; z-index: 100; transition: all 0.5s ease; }

        .floating-text {
            position: absolute;
            font-family: 'Fredoka One', cursive;
            font-size: 50px;
            pointer-events: none;
            z-index: 110;
            text-shadow: 4px 4px 0px rgba(0,0,0,0.1);
            animation: floatUp 1.5s forwards;
        }
        @keyframes floatUp { 0% { transform: translateY(0) scale(0.3); opacity: 0; } 30% { opacity: 1; } 100% { transform: translateY(-180px) scale(1.2); opacity: 0; } }

        .sun-effect { position: absolute; top: 20px; right: 20px; font-size: 150px; animation: sun-spin 15s linear infinite; display: none; z-index: 100; }
        @keyframes sun-spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        .sun-overlay { position: fixed; inset: 0; background: radial-gradient(circle at top right, rgba(251, 191, 36, 0.4), transparent 70%); pointer-events: none; display: none; z-index: 2; }

        .btn-fancy { @apply transition-all duration-200 active:scale-95 hover:brightness-105 shadow-xl; border-bottom: 6px solid rgba(0,0,0,0.15); }
        .card { background: rgba(255, 255, 255, 0.9); border-radius: 24px; box-shadow: 0 8px 0px rgba(0,0,0,0.05); }

        #resetModal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 500; display: none; align-items: center; justify-content: center; }
        
        /* Cloud Sync Status Icon */
        #syncStatus { position: absolute; top: 10px; right: 10px; font-size: 12px; font-weight: bold; color: #94a3b8; }
    </style>

    <script>
    // Local storage fallback
    const STORAGE_KEY = 'growth-garden-progress';
    
    window.gameCore = {
        db: null,
        user: { uid: 'local-user' },
        appId: 'local-garden'
    };
    
    window.saveProgressToCloud = function() {
        if (!window.state) return;
        localStorage.setItem(STORAGE_KEY, JSON.stringify({
            height: window.state.height,
            level: window.state.level,
            lastSaved: Date.now()
        }));
    };
    
    window.loadProgressFromCloud = function() {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
            const data = JSON.parse(saved);
            window.state.height = data.height || 0;
            window.state.level = data.level || 0;
            if (window.updateUI) updateUI(true);
        }
    };
</script>
</head>
<body>

    <!-- Reset Confirmation Modal -->
    <div id="resetModal">
        <div class="card p-8 text-center max-w-sm mx-auto">
            <h2 class="title-font text-2xl text-red-500 mb-4 uppercase">Reset Garden?</h2>
            <p class="text-gray-600 mb-6 font-bold">ÊâÄÊúâÈÄ≤Â∫¶Â∞áÊúÉÊ∂àÂ§±„ÄÇÁ¢∫ÂÆöÂóéÔºü<br>(All progress will be lost.)</p>
            <div class="flex gap-4">
                <button onclick="closeResetModal()" class="flex-1 py-3 bg-gray-200 rounded-xl font-bold">Cancel</button>
                <button onclick="performReset()" class="flex-1 py-3 bg-red-500 text-white rounded-xl font-bold">Reset</button>
            </div>
        </div>
    </div>

    <!-- Celebration Overlay -->
    <div id="celebrationOverlay" class="celebration-overlay" onclick="closeCelebration()">
        <div class="text-center">
            <h2 class="title-font text-5xl text-pink-500 mb-4 uppercase">Harvest Time!</h2>
            <div id="celebrationFruit" class="text-[150px] mb-4">üçé</div>
            <div id="celebrationWord" class="title-font text-6xl text-blue-600 uppercase tracking-widest mb-2">APPLE</div>
            <p class="text-xl text-gray-500 font-bold italic">Click anywhere to continue</p>
        </div>
    </div>

    <div id="sunOverlay" class="sun-overlay"></div>
    <div id="sunIcon" class="sun-effect">‚òÄÔ∏è</div>

    <!-- Left Section: Garden Display -->
    <section class="left-section flex flex-col p-4 md:p-8">
        <div id="syncStatus">‚òÅÔ∏è Syncing...</div>
        
        <div class="card p-6 flex flex-col gap-2 border-4 border-blue-100 z-20 self-start">
            <h1 class="title-font text-2xl text-blue-500 uppercase tracking-widest">Growth Garden</h1>
            <div class="flex items-center gap-10">
                <div class="flex flex-col">
                    <span class="text-[10px] font-black text-gray-400 uppercase">Height</span>
                    <span id="displayHeight" class="text-4xl font-bold text-green-500 title-font">0 cm</span>
                </div>
                <div class="h-12 w-[3px] bg-blue-50"></div>
                <div class="flex flex-col text-center">
                    <span class="text-[10px] font-black text-gray-400 uppercase">Level</span>
                    <span id="displayLevel" class="text-3xl font-bold text-orange-400 title-font">1/10</span>
                </div>
            </div>
        </div>

        <div class="flex-1 relative flex flex-col items-center justify-end overflow-visible">
            <div id="wateringCan">üöø</div>
            <div id="feedbackContainer"></div>
            <div class="plant-container">
                <div id="fruitOnTree" class="fruit-on-tree"></div>
                <div id="plant" class="plant-sprite bounce" style="--current-scale: 0.35;">üå±</div>
                <div class="mt-4 px-8 py-2 bg-white rounded-full text-green-600 font-black shadow-lg z-20 border-2 border-green-100">
                    <span id="stageName">Tiny Seed</span>
                </div>
            </div>
            <div class="grass"></div>
        </div>

        <button onclick="openResetModal()" class="absolute bottom-4 left-4 text-[10px] font-bold text-gray-400 hover:text-red-500 underline opacity-40 hover:opacity-100 transition-all z-30 uppercase">Reset Progress</button>
    </section>

    <!-- Right Section: Controls -->
    <section class="right-section p-6 md:p-8 flex flex-col gap-6">
        <div class="card p-6 flex flex-col items-center border-4 border-indigo-100">
            <span class="text-xs font-black text-gray-400 mb-2 uppercase tracking-wider">Focus Reward</span>
            <div id="timerDisplay" class="text-5xl font-mono font-bold text-indigo-500 mb-4">--:--</div>
            <div class="flex gap-4 w-full">
                <button onclick="startFocusTimer(1200)" class="btn-fancy bg-indigo-500 text-white flex-1 py-3 rounded-2xl text-lg font-bold">20M</button>
                <button onclick="startFocusTimer(1800)" class="btn-fancy bg-purple-500 text-white flex-1 py-3 rounded-2xl text-lg font-bold">30M</button>
            </div>
        </div>

        <div class="grid grid-cols-1 gap-4">
            <button onclick="directWater('task')" class="btn-fancy bg-yellow-400 p-6 rounded-[30px] flex items-center gap-6 text-left">
                <span class="text-5xl">‚≠ê</span>
                <div>
                    <div class="title-font text-xl text-yellow-900 leading-tight uppercase">Good Work</div>
                    <div class="text-xs text-yellow-800 font-bold mt-1 italic">Ë™≤Â†ÇÂ∞è‰ªªÂãô (+1~5)</div>
                </div>
            </button>

            <button onclick="directWater('bonus')" class="btn-fancy bg-pink-500 p-6 rounded-[30px] flex items-center gap-6 text-left">
                <span class="text-5xl">üéÅ</span>
                <div>
                    <div class="title-font text-xl text-white leading-tight uppercase">Teacher Bonus</div>
                    <div class="text-xs text-pink-100 font-bold mt-1 italic">ËÄÅÂ∏´ÁâπÂà•ÁçéÂãµ (+5~15)</div>
                </div>
            </button>

            <button onclick="toggleSunPenalty()" id="sunBtn" class="btn-fancy bg-orange-600 p-6 rounded-[30px] flex items-center gap-6 text-left">
                <span id="sunBtnIcon" class="text-5xl">üî•</span>
                <div>
                    <div id="sunBtnTitle" class="title-font text-xl text-white leading-tight uppercase">Sun Attack</div>
                    <div id="sunBtnSub" class="text-xs text-orange-100 font-bold mt-1 italic">Â§ßÂ§™ÈôΩËôïÁΩ∞ (Ê∏õÂ∞ëÊ∞¥ÂàÜ)</div>
                </div>
            </button>
        </div>

        <div class="mt-auto text-center text-gray-400 text-[10px] font-bold py-4">
            MAGIC GARDEN CLOUD SYNC V2.2
        </div>
    </section>

    <script type="module">
        import { doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Game Configuration
        const fruits = [
            { emoji: 'üçé', word: 'APPLE' },
            { emoji: 'üçä', word: 'ORANGE' },
            { emoji: 'üçê', word: 'PEAR' },
            { emoji: 'üçá', word: 'GRAPES' },
            { emoji: '‚ú®üçé', word: 'GOLDEN APPLE' }
        ];

        window.state = {
            height: 0,
            level: 0,
            isSunning: false,
            isTimerRunning: false,
            timer: null,
            sunLossTracker: 0,
            stages: [
                { min: 0, emoji: 'üå±', name: 'Tiny Seed', title: 'Level 1' },
                { min: 30, emoji: 'üåø', name: 'Sprout', title: 'Level 2' },
                { min: 80, emoji: 'üçÄ', name: 'Little Leaf', title: 'Level 3' },
                { min: 150, emoji: 'ü™¥', name: 'Small Plant', title: 'Level 4' },
                { min: 250, emoji: 'üå≤', name: 'Young Tree', title: 'Level 5' },
                { min: 400, emoji: 'üå≥', name: 'Tall Tree', title: 'Level 6' },
                { min: 600, emoji: 'üå¥', name: 'Tropical Tree', title: 'Level 7' },
                { min: 850, emoji: 'üéã', name: 'Ancient Tree', title: 'Level 8' },
                { min: 1150, emoji: 'üå≥‚ú®', name: 'Golden Tree', title: 'Level 9' },
                { min: 1500, emoji: 'üå≥', name: 'Harvest Tree', title: 'MAX LEVEL' }
            ]
        };

        // DOM Elements
        const elPlant = document.getElementById('plant');
        const elHeight = document.getElementById('displayHeight');
        const elLevel = document.getElementById('displayLevel');
        const elStageName = document.getElementById('stageName');
        const elTimer = document.getElementById('timerDisplay');
        const elCan = document.getElementById('wateringCan');
        const elSun = document.getElementById('sunIcon');
        const elSunOverlay = document.getElementById('sunOverlay');
        const elFruitOnTree = document.getElementById('fruitOnTree');
        const elCeleb = document.getElementById('celebrationOverlay');
        const elCelebFruit = document.getElementById('celebrationFruit');
        const elCelebWord = document.getElementById('celebrationWord');
        const feedbackContainer = document.getElementById('feedbackContainer');
        const elSync = document.getElementById('syncStatus');

        // Cloud Persistence Logic
        async function saveProgressToCloud() {
            if (!window.gameCore.user || !window.gameCore.db) return;
            elSync.innerText = "‚òÅÔ∏è Saving...";
            try {
                const userDoc = doc(window.gameCore.db, 'artifacts', window.gameCore.appId, 'users', window.gameCore.user.uid, 'garden', 'progress');
                await setDoc(userDoc, {
                    height: window.state.height,
                    level: window.state.level,
                    lastSaved: Date.now()
                });
                elSync.innerText = "‚òÅÔ∏è Saved";
            } catch (e) {
                elSync.innerText = "‚ùå Offline";
            }
        }

        window.loadProgressFromCloud = async function() {
            if (!window.gameCore.user || !window.gameCore.db) return;
            elSync.innerText = "‚òÅÔ∏è Loading...";
            try {
                const userDoc = doc(window.gameCore.db, 'artifacts', window.gameCore.appId, 'users', window.gameCore.user.uid, 'garden', 'progress');
                const snap = await getDoc(userDoc);
                if (snap.exists()) {
                    const data = snap.data();
                    window.state.height = data.height || 0;
                    window.state.level = data.level || 0;
                    updateUI(true); // silent update
                    elSync.innerText = "‚òÅÔ∏è Synced";
                } else {
                    elSync.innerText = "‚òÅÔ∏è New Garden";
                }
            } catch (e) {
                elSync.innerText = "‚ùå Sync Failed";
            }
        };

        // Core Game Functions
        window.updateUI = function(silent = false) {
            elHeight.innerText = `${Math.floor(window.state.height)} cm`;
            
            let currentLevel = 0;
            for(let i = window.state.stages.length - 1; i >= 0; i--) {
                if(window.state.height >= window.state.stages[i].min) {
                    currentLevel = i;
                    break;
                }
            }

            if(currentLevel > window.state.level) {
                window.state.level = currentLevel;
                elPlant.innerText = window.state.stages[window.state.level].emoji;
                elLevel.innerText = `${window.state.level + 1}/10`;
                elStageName.innerText = window.state.stages[window.state.level].name;
                if(!silent) triggerEffect('LEVEL UP!', '#f59e0b');
                if (window.state.level === 9 && !silent) harvestFruit();
            } else if (currentLevel < window.state.level) {
                window.state.level = currentLevel;
                elPlant.innerText = window.state.stages[window.state.level].emoji;
                elLevel.innerText = `${window.state.level + 1}/10`;
                elStageName.innerText = window.state.stages[window.state.level].name;
                
                if(!silent) {
                    triggerEffect('OH NO! BEHAVE!', '#ef4444');
                    document.body.classList.add('danger-shake');
                    setTimeout(() => document.body.classList.remove('danger-shake'), 1000);
                }
            } else {
                // Ensure correct emoji even if level didn't change (e.g. on load)
                elPlant.innerText = window.state.stages[window.state.level].emoji;
                elLevel.innerText = `${window.state.level + 1}/10`;
                elStageName.innerText = window.state.stages[window.state.level].name;
            }

            const baseScale = 0.35;
            const growthScale = window.state.height / 800; 
            const finalScale = Math.min(2.2, baseScale + growthScale);
            elPlant.style.setProperty('--current-scale', finalScale);
            elPlant.style.transform = `scale(${finalScale})`;

            if(!silent) saveProgressToCloud();
        };

        window.harvestFruit = function() {
            const randIdx = Math.floor(Math.random() * fruits.length);
            const fruit = fruits[randIdx];
            elFruitOnTree.innerHTML = `<span class="text-4xl">${fruit.emoji}</span><span class="text-4xl">${fruit.emoji}</span>`;
            elCelebFruit.innerText = fruit.emoji;
            elCelebWord.innerText = fruit.word;
            elCeleb.style.display = 'flex';
        };

        window.closeCelebration = function() { elCeleb.style.display = 'none'; };

        window.openResetModal = function() { document.getElementById('resetModal').style.display = 'flex'; };
        window.closeResetModal = function() { document.getElementById('resetModal').style.display = 'none'; };
        
        window.performReset = async function() {
            window.state.height = 0;
            window.state.level = 0;
            window.state.sunLossTracker = 0;
            if (window.state.isSunning) toggleSunPenalty();
            if (window.state.isTimerRunning) {
                clearInterval(window.state.timer);
                window.state.isTimerRunning = false;
                elTimer.innerText = "--:--";
            }
            elFruitOnTree.innerHTML = "";
            updateUI();
            closeResetModal();
            triggerEffect("RESET DONE!", "#6366f1");
        };

        window.directWater = function(type) {
            const rect = elPlant.getBoundingClientRect();
            elCan.style.opacity = '1';
            elCan.style.left = (rect.left - 70) + 'px';
            elCan.style.top = (rect.top - 100) + 'px';
            elCan.style.transform = 'rotate(-45deg)';

            setTimeout(() => {
                elCan.style.transform = 'rotate(-10deg)';
                elCan.style.opacity = '0';
                processGrowth(type);
            }, 600);
        };

        function processGrowth(type) {
            let missChance = 0.3; 
            let superChance = 0.1;
            let baseGrowth = 3;

            if (type === 'bonus') {
                missChance = 0.15; superChance = 0.2; baseGrowth = 10;
            } else if (type === 'timer') {
                missChance = 0; superChance = 0.5; baseGrowth = 30;
            }

            const rand = Math.random();
            let finalGrow = 0;
            let msg = "";
            let color = "#4ade80";

            if (rand < missChance) {
                msg = "UNLUCKY! +0"; color = "#ef4444";
                elPlant.classList.add('shake');
                setTimeout(() => elPlant.classList.remove('shake'), 500);
            } else if (rand > (1 - superChance)) {
                finalGrow = baseGrowth * 2;
                msg = "SUPER! +" + Math.floor(finalGrow);
                color = "#d946ef";
            } else {
                finalGrow = baseGrowth + (Math.random() * 3);
                msg = "GROW! +" + Math.floor(finalGrow);
                color = "#3b82f6";
            }

            if (window.state.isSunning) finalGrow /= 2;

            window.state.height += finalGrow;
            triggerEffect(msg, color);
            updateUI();
        }

        function triggerEffect(text, color) {
            const div = document.createElement('div');
            div.className = 'floating-text';
            div.innerText = text;
            div.style.color = color;
            div.style.left = (window.innerWidth < 1024) ? '50%' : '30%';
            div.style.marginLeft = '-150px';
            div.style.top = '40%';
            feedbackContainer.appendChild(div);
            setTimeout(() => div.remove(), 1500);
        }

        window.toggleSunPenalty = function() {
            window.state.isSunning = !window.state.isSunning;
            const btn = document.getElementById('sunBtn');
            if (window.state.isSunning) {
                elSun.style.display = 'block';
                elSunOverlay.style.display = 'block';
                btn.classList.replace('bg-orange-600', 'bg-yellow-700');
                document.getElementById('sunBtnTitle').innerText = "RESTORE";
                
                window.state.sunLossTracker = 0;
                window.state.sunInterval = setInterval(() => {
                    if (window.state.height > 0) {
                        const deduction = 0.5;
                        window.state.height -= deduction;
                        window.state.sunLossTracker += deduction;
                        if (window.state.sunLossTracker >= 5) {
                            triggerEffect("-5 cm", "#ea580c");
                            window.state.sunLossTracker = 0;
                        }
                        updateUI();
                    }
                }, 1000);
            } else {
                elSun.style.display = 'none';
                elSunOverlay.style.display = 'none';
                btn.classList.replace('bg-yellow-700', 'bg-orange-600');
                document.getElementById('sunBtnTitle').innerText = "Sun Attack";
                clearInterval(window.state.sunInterval);
                saveProgressToCloud();
            }
        };

        window.startFocusTimer = function(seconds) {
            if (window.state.isTimerRunning) return;
            window.state.isTimerRunning = true;
            let remaining = seconds;
            const updateTime = (s) => {
                const m = Math.floor(s / 60);
                const sec = s % 60;
                elTimer.innerText = `${m.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
            };
            updateTime(remaining);
            window.state.timer = setInterval(() => {
                remaining--;
                updateTime(remaining);
                if (remaining <= 0) {
                    clearInterval(window.state.timer);
                    window.state.isTimerRunning = false;
                    directWater('timer');
                    elTimer.innerText = "YAY!";
                }
            }, 1000);
        };

        // Initialize display
        updateUI(true);
    </script>
</body>
</html>
